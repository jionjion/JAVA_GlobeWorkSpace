package com.model.proxy.dynamical.proxy;

import java.io.File;
import java.io.IOException;
import java.lang.reflect.Constructor;
import java.lang.reflect.Method;

import javax.tools.JavaCompiler;
import javax.tools.JavaFileObject;
import javax.tools.StandardJavaFileManager;
import javax.tools.ToolProvider;
import javax.tools.JavaCompiler.CompilationTask;

import org.apache.commons.io.FileUtils;

/**自定义实现动态代理类*/
public class Proxy {

	
	/**自定义返回一个动态代理 */
	public static Object newProxyInstance(Class inface) throws Exception{
		//1.声明一段源码
		String rt = "\t\n";
		String methodName = "";
		String code = "";
		
		for(Method method : inface.getMethods() ){
			methodName += 
		"	@Override														"+rt+
		"	/**将传入的父类对象进行调用相同的方法,并增加相关功能*/							"+rt+
		"	public void "+ method.getName() +"() {											"+rt+
		"		long startTime = System.currentTimeMillis();				"+rt+
		"		car."+ method.getName() +"();													"+rt+
		"		long endTime = System.currentTimeMillis();					"+rt+	
		"		System.out.println(\"汽车行驶时间\"+(endTime-startTime)+\"毫秒\");"+rt+
		"	}																";
		}
		
		code += 
"	package com.model.proxy.statical;								"+rt+
"	/**	静态代理														"+rt+
"	 * 	通过聚合的方式实现相同的接口,完成继承.*/								"+rt+
"	public class $CarBrother0 implements " +inface.getName()+ "{	"+rt+
"	/**传入接口的实现类,进行调用*/											"+rt+
"	private " +inface.getName()+ " car;												"+rt+
"	public $CarBrother0(" +inface.getName()+ " car) {									"+rt+
"		super();													"+rt+
"		this.car = car;												"+rt+
"	}																"+rt+
		methodName+
"}																	";
		//2.生成文件,编译源码
		//获得当前的路径
		String fileName = System.getProperty("user.dir");
		System.out.println("当前文件的路径:"+fileName);
		//创建编译环境
		fileName = fileName + "/bin/com/model/proxy/statical/$CarBrother0.java";
		File file = new File(fileName);
		FileUtils.write(file, code);
		//拿到编译器
		JavaCompiler javaCompiler = ToolProvider.getSystemJavaCompiler();
		//得到文件管理者
		StandardJavaFileManager standardJavaFileManager = 
					javaCompiler.getStandardFileManager(null, null, null);
		//得到文件
		Iterable<? extends JavaFileObject> units = standardJavaFileManager.getJavaFileObjects(fileName);
		//编译任务
		CompilationTask compilationTask = javaCompiler.getTask(null, standardJavaFileManager, null, null, null, units);
		//进行编译
		compilationTask.call();
		//关闭
		standardJavaFileManager.close();
		
		//加载到内存中
		ClassLoader classLoader = ClassLoader.getSystemClassLoader();
		Class<?> c = classLoader.loadClass("com.model.proxy.statical.$CarBrother0");
		System.out.println("加载自定义的类:"+c.getName());
		
		//根据构造器创建对象
		Constructor<?> constructor = c.getConstructor(inface);
		//返回创建对象
		return constructor.newInstance(initargs);
	}
}
