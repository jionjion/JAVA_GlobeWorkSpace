/*自定义JS*/

/**
 * 	候选词选择对象
 */
var switch_object = {
	//最大候选词数量
	word_max : 10,	
	//当前选择索引,-1表示未进行索引
	word_idx : -1,	
}

/**
 * 	按钮组对象状态
 */
var buttons_object = {
	//是否处于修改状态
	current_modify : false,
}

/* 阻止浏览器默认右键 */
document.oncontextmenu = function() {
    return false;
}

$(function(){
	
	// 绑定鼠标选择事件
// 	$('#guider-input-option-group').click(function(e){
// 		var clicl_object = e.target;
// 		if(clicl_object && clicl_object.innerHTML){
// 			$('#search-input-text').val(clicl_object.innerHTML);
// 			debugger;
// 		}
// 	})
	
	// 删除输入框
	$('#search-input-text-close_btn').click(function(e){
		$('#search-input-text').val('');
		$('#guider-input-option-group').html('');
		$('#search-input-text-close_btn').hide();
	})
	
	
	// 绑定键盘监听事件
	$('#search-input-text').keydown(function(e){
		var keyCode = event.keyCode;
		
		// 阻止input事件冒泡
		if (38 == keyCode || 40 == keyCode) {
			e.preventDefault();
		}
		
		// 小键盘下键选择  38 小键盘上键		40 小键盘下键		32 空格键		27 ESC键
		if(keyCode == 40){
				switch_object.word_idx = switch_object.word_idx + 1;
				if(switch_object.word_idx >= switch_object.word_max){
					// 最后一行超出索引范围,返回第一行
					switch_object.word_idx = 0;
				}
				// 改变样式
				var group = $('#guider-input-option-group');
				// 列表
				var li_arrs = group.find('li');
				for (var i=0 ; i < li_arrs.length ; i++){
					// 选中元素,增加选中样式;其他去除样式
					if(i == switch_object.word_idx){
						li_arrs[i].style['background-color'] = '#dae0e5';
						// 替换当前输入框中的元素
						$('#search-input-text').val(li_arrs[i].innerText);
					}else{
						li_arrs[i].style['background-color'] = 'white';
					}
				}
		}
		// 上键
		if(keyCode == 38){
				switch_object.word_idx = switch_object.word_idx - 1;
				if(switch_object.word_idx < 0){
					// 第一行超出索引范围,返回最后一行.索引-1
					switch_object.word_idx = switch_object.word_max - 1;
				}
				// 改变样式
				var group = $('#guider-input-option-group');
				// 列表
				var li_arrs = group.find('li');
				for (var i=0 ; i < li_arrs.length ; i++){
					// 选中元素,增加选中样式;其他去除样式
					if(i == switch_object.word_idx){
						li_arrs[i].style['background-color'] = '#dae0e5';
						// 替换当前输入框中的元素
						$('#search-input-text').val(li_arrs[i].innerText);
					}else{
						li_arrs[i].style['background-color'] = 'white';
					}
				}
		}
	})
	
	
	// 绑定键盘监听事件
	$('#search-input-text').keyup(function(e){
		
		var input_str = $('#search-input-text').val();
		if(!input_str){
			// 清空返回
			var group = $('#guider-input-option-group');
			group.html('');
			// 不显示
			$('#search-input-text-close_btn').hide();
			return;
		}else{
			$('#search-input-text-close_btn').show();
		}
		var keyCode = event.keyCode;
		var arr = [37, 38, 39, 40];
		// 不为小键盘上下左右事件,发送百度请求
		if(arr.indexOf(keyCode) == -1){
			// get请求
			$.ajax({
				type:"get",
				//url:"http://suggestion.baidu.com/su?cb=window.baidu.sug&" + "wd=" + input_str,
				// https支持的URL
				url:"https://sp0.baidu.com/5a1Fazu8AA54nxGko9WTAnF6hhy/su?cb=window.baidu.sug&" + "wd=" + input_str,
				async: false,
				// 通信方式
				dataType:'jsonp',
				// 回调函数
				jsonpCallback:"window.baidu.sug"
			});	
			//当前索引位置重置
			switch_object.word_idx = -1;
		}
		

	});
	window.baidu= {};
	window.baidu.sug = function (data){
        var x = JSON.stringify(data);
        x = JSON.parse(x);
        add_input_option(x.s);
	}
	// 输入框显示函数
	function add_input_option (arr) {
		var group = $('#guider-input-option-group');
		group.html('');
		$.each(arr, function(i, item) {
			group.append('<li class="guider-input-option-li list-group-item-action">'+ item +'</li>');
		});
		// 修改最大候选词
    switch_object.word_max = arr.length;
	}
	
	
	// 弹窗保存按钮
	$('#guider-uri-save-btn').click(function(e){
		var siteName = $('#siteName').val();
		var siteUri = $('#siteUri').val();
		// 新增按钮
		addUriTemplet(siteName,siteUri);
		// 关闭弹窗
		$('#addUriModalCenter').modal('hide');
		// 清空值
		$('#siteName').val('');
		$('#siteUri').val('');
		// 发送post请求
		$.ajax({
			type: "POST",
			dataType: 'json',
			contentType: "application/json",
			url: "/api/website",
			data:JSON.stringify({
				siteName:siteName,
				siteUri:siteUri
			})
		});
	})
	
	// 链接按钮上右击,进行修改,预定义事件
	$('#guider-work-space').on('contextmenu','.guider-uri-btn',function(e){
		
		// 1.修改按钮组状态
		buttons_object.current_modify = true;
		// 2.显示新增组件
		$('#guider-uri-add-btn').show();
		// 3.显示删除图标
		$('.guider-delete-btn').show();
		
	})
	
	// 工作空间内左击,根据点击部位确定具体功能
	$('#guider-work-space').on('click',function(e){
		
		// 点击工作空间
		if(e.target.id && e.target.id=="guider-work-space"){
			// 1.修改按钮组状态
			buttons_object.current_modify = false;
			// 2.显示新增组件
			$('#guider-uri-add-btn').hide();
			// 3.显示删除图标
			$('.guider-delete-btn').hide();			
		}
		
	});
	
	// 删除按钮,预定义事件
	$('#guider-work-space').on('click','.guider-delete-btn',function(e){
		// 隐藏按钮
		$(e.target).parent('.guider-uri-btn').hide();
		// 删除元素
		var siteId = $(e.target).parent('a').prevObject.attr('data');
		if(siteId){
			$.ajax({
				type: "DELETE",
				dataType: 'json',
				contentType: "application/json",
				url: "/api/website/" + siteId,
			});
		}
	});
	
// 	// 模态弹窗弹出
// 	$('#addUriModalCenter').on('show.bs.modal', function (e) {
// 		debugger;
// 	});

	/* 新增链接按钮,并在前台显示 */
	function addUriTemplet(siteName,siteUri){

		var templet = '<div class="col-lg-2 pt-md-2 guider-uri-btn">'
					+				'<a href=http://"'+ siteUri +'" title="'+ siteName +'">'
					+					'<div class="bg-white rounded shadow-lg">'
					+						'<img width="26px" height="28px" src="http://'+ siteUri +'/favicon.ico" onerror="this.src=\'img/icon-e.png\';this.onerror=null" class="d-inline-block align-middle py-sm-1 pl-sm-1"/>'
					+						'<span class="py-sm-1 text-truncate d-inline-block align-middle text-secondary">'
					+							 siteName
					+						'</span>'
					+					'</div>'
					+				'</a>'
					+				'<a href="javascript:void(0);" class="position-absolute guider-delete-btn">&times;</a>'
					+			'</div>';
					
		$('#guider-uri-add-btn').before(templet);
	}
	
	
	/* 侧边栏显示与隐藏 */
    $(document).click(function (e) {
		// 侧边栏按钮区域
		var icon_list_area = $('#sidebar-ico');
		// 侧边栏区域
        var sidebar_others_area = $("#sidebar");
		// 如果点击侧边栏按钮
		if(icon_list_area.is(e.target) || icon_list_area.has(e.target).length > 0){
			sidebar_others_area.show();
			icon_list_area.hide();
			return;
		}
		
		// 侧边栏以外关闭
        if (!sidebar_others_area.is(e.target) && sidebar_others_area.has(e.target).length === 0) {
			sidebar_others_area.hide();
			icon_list_area.show();
			return;
        }
    });
 
	
})